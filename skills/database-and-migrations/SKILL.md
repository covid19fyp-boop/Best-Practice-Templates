---
name: database-and-migrations
description: Apply PostgreSQL-first data ownership and safe schema evolution practices for modular monolith systems. Use when designing schemas, writing migrations, handling idempotency, and protecting data during releases.
---

# Database And Migrations

## Instructions

1. Use PostgreSQL as the default transactional datastore.
2. Define data ownership by module:
   - One module owns each write path
   - Other modules consume via interfaces, not direct writes
3. Treat schema changes as versioned code changes:
   - Commit migration files with application code
   - Review autogenerated migrations before applying
4. Use expand -> migrate -> contract for breaking changes:
   - Expand: add backward-compatible structures
   - Migrate: backfill/read-switch safely
   - Contract: remove deprecated structures last
5. Protect finance-like endpoints with idempotency keys for safe retries.
6. Test migrations in CI against real Postgres where possible.
7. Prepare rollback and restore notes for every risky migration.

Use with:

- `skills/testing-strategy/SKILL.md`
- `skills/release-and-versioning/SKILL.md`
- `skills/security-and-secrets/SKILL.md`

## Decision Criteria

- Prefer additive schema changes unless deprecation is complete.
- Use direct destructive DDL only when rollback and downtime implications are accepted.
- Split database ownership only when service boundaries are stable and justified.
- Treat migration correctness as release-critical.

## Examples

### Example 1: Safe column rename plan

```text
Design an expand-migrate-contract plan to rename transactions.amount_minor to transactions.amount_cents.
Include code rollout order, dual-read/write period, and rollback strategy.
```

### Example 2: Data ownership review

```text
Review table ownership across finance/dev/core modules.
Identify cross-module write violations and propose interface-based fixes.
```

### Example 3: Idempotency implementation plan

```text
Create a PostgreSQL-backed idempotency-key design for POST /finance/transactions.
Cover key storage, replay semantics, and duplicate prevention tests.
```

## Anti-Patterns

- Manual production schema changes outside version control.
- Applying autogenerated migrations without review.
- Direct cross-module table writes for convenience.
- Dropping columns/tables before all readers are migrated.

## Checklist

- [ ] PostgreSQL schema ownership is explicit per module.
- [ ] Migration files are committed and reviewed.
- [ ] Breaking changes use expand-migrate-contract.
- [ ] Idempotency exists for retry-sensitive write endpoints.
- [ ] Migration tests run in CI.
- [ ] Rollback/restore notes are prepared.
